{% extends 'base.html.twig' %}

{% block title %}Grand livres des comptes{% endblock %}

{% block stylesheets %}
    <link href="{{ asset('assets/libs/datatable/dist/dataTables.bootstrap4.css') }}" rel="stylesheet">
{% endblock %}

{% block header %}
    <div class="page-breadcrumb">
        <div class="d-flex align-items-center">
            <h4 class="page-title text-truncate text-dark font-weight-medium mb-0">Grand livre des comptes</h4>
            <div class="ml-auto">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb m-0 p-0">
                        <li class="breadcrumb-item text-muted active" aria-current="page">Comptabilité</li>
                        <li class="breadcrumb-item text-muted" aria-current="page">Grand livre</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
{% endblock %}

{% block body %}
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Grand livre {% if isAux %}auxilliaire{% else %}generale{% endif %}</h4>
                    <hr>   
                    <div class="row mb-4">
                        <div class="col-md-10">
                            <div class="form-row">
                                <div class="col-sm-6">
                                    <select name="compte" id="compte" class="form-control">
                                        <option value="">Tous les comptes</option>
                                        {% for compte in labelComptes %}
                                            <option value="/{{ compte.poste }}">{{ compte.poste ~' '~ compte.titre}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-sm-4">
                                    <a href="/comptabilite/grandlivre" id="link" class="btn btn-info">Acceder</a>
                                </div>
                            </div>
                        </div>                       
                    </div>                        
                    <div class="table-responsive-lg">
                        <table class="table table-bordered">
                            <thead class="thead-light">
                                <tr>
                                    <th scope="col">Date</th>
                                    <th scope="col">Libellé</th>
                                    <th scope="col">Réference</th>
                                    <th scope="col">Journal</th>
                                    <th scope="col">Débit</th>
                                    <th scope="col">Crédit</th>
                                </tr>
                            </thead>
                            {% if not isAux %}                            
                                <tbody>
                                    {% for classe, comptes in donnees %}
                                        <tr><th colspan=6>{{ classe }}</th></tr>
                                        {% for compte, articles in comptes %}
                                            <tr><th colspan=6  class="table-active">{{ compte }}</th></tr> 
                                            {% set debit = 0 %} {% set credit = 0 %}
                                            {% for article in articles %}
                                                <tr>
                                                    <td>{{ article.date |date('d/m/Y') }}</td>
                                                    <td>{{ article.libelle }}</td>
                                                    <td>{{ article.piece }}</td>
                                                    <td>{{ article.categorie }}</td>
                                                    <td>{% if article.debit %}{{ article.debit|number_format(2,',',' ') }}{% endif %}</td> {% set debit = debit + article.debit %}
                                                    <td>{% if article.credit %}{{ article.credit|number_format(2,',',' ') }}{% endif %}</td> {% set credit = credit + article.credit %}
                                                </tr>
                                            {% endfor %}  
                                            <tr>
                                                <th colspan=4>Total : {{ compte }}</span></th>
                                                <td>{{ debit|number_format(2,',',' ') }}</td>
                                                <td>{{ credit|number_format(2,',',' ') }}</td>
                                            </tr>    
                                        {% endfor %}
                                    {% endfor %}        
                                </tbody>
                            {% else %}
                                <tbody>
                                    <tr><th colspan=6>{{ donnees.compte.classe }}</th></tr>
                                    <tr><th colspan=6>{{ donnees.compte.poste ~' '~ donnees.compte.titre }}</th></tr>
                                    {% set debit = 0 %} {% set credit = 0 %}
                                    {% for article in donnees.articles %}
                                        <tr>
                                            <td>{{ article.date |date('d/m/Y') }}</td>
                                            <td>{{ article.libelle }}</td>
                                            <td>{{ article.piece }}</td>
                                            <td>{{ article.categorie }}</td>
                                            <td>{% if article.debit %}{{ article.debit|number_format(2,',',' ') }}{% endif %}</td> {% set debit = debit + article.debit %}
                                            <td>{% if article.credit %}{{ article.credit|number_format(2,',',' ') }}{% endif %}</td> {% set credit = credit + article.credit %}
                                        </tr>
                                    {% else %}
                                        <tr>
                                            <td colspan=6>Aucune opération à afficher</td>
                                        </tr>
                                    {% endfor %} 
                                    <tr>
                                        <th colspan=4>Total : {{ donnees.compte.poste ~' '~ donnees.compte.titre }}</span></th>
                                        <td>{{ debit|number_format(2,',',' ') }}</td>
                                        <td>{{ credit|number_format(2,',',' ') }}</td>
                                    </tr>     
                                </tbody>
                            {% endif %}

                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script src="{{ asset('assets/libs/datatable/dist/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('dist/js/pages/datatable/datatable-basic.init.js') }}"></script>
    <script>
        $(document).ready(function() {  
            var url = window.location + "";
            var value = url.replace(window.location.protocol + "//" + window.location.host + "{{ path('comptabilite_livre') }}", ""); 
            var element = $('#compte option').filter(function() {
                return this.value === value;
            });
            element.attr('selected', 'selected');

            $('#link').click(function(e) {
                e.preventDefault();
                window.location.href = "{{ path('comptabilite_livre') }}"+ $('#compte').val();
            });    
        });
    </script>
{% endblock %}