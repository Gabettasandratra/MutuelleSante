{% extends 'base.html.twig' %}

{% block title %}Plan Tiers{% endblock %}

{% block header %}
    <div class="page-breadcrumb">
        <div class="d-flex align-items-center">
            <h4 class="page-title text-truncate text-dark font-weight-medium mb-0">Plan Tiers</h4>
            <div class="ml-auto">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb m-0 p-0">
                        <li class="breadcrumb-item text-muted active" aria-current="page">Comptabilité</li>
                        <li class="breadcrumb-item text-muted" aria-current="page">Plan Tiers</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
{% endblock %}
{% block body %}
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                  
                    <div class="col-8">
                      <h4 class="card-title">Plan des tiers</h4>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-sm btn-info" data-toggle="modal" data-target="#form-dialog"><i class="fa fa-plus-circle" aria-hidden="true"></i> Ajouter nouveau tier</button>
                    </div>
                    <hr>
                    <div class="row">                       
                        <table class="table table-hover table-striped border" id="tiers">
                            <thead class="thead-light">
                                <tr>
                                    <th scope="col">Type</th>
                                    <th scope="col">Code</th>
                                    <th scope="col">Intitulé</th>
                                    <th scope="col">Adresse</th>
                                    <th scope="col">Contact</th>
                                    <th scope="col">Compte collectif</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>                            
                    </div>
                   
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" tabindex="-1" id="form-dialog" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-light">
                    <h5 class="modal-title" id="exampleModalLabel">Ajouter un nouveau compte tier</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form method="post" id="form">
                        <div class="form-group row">
                            <label for="code" class="col-form-label col-sm-3 required">Code tier</label>
                            <div class="col-sm-9">
                                <input type="text" id="code" name="code" required="required" class="form-control" placeholder="Code unique"/>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="libelle" class="col-form-label col-sm-3 required">Intitulé</label>
                            <div class="col-sm-9">
                                <input type="text" id="libelle" name="libelle" required="required" class="form-control" placeholder="Nom"/>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="adresse" class="col-form-label col-sm-3 required">Adresse</label>
                            <div class="col-sm-9">
                               <textarea id="adresse" name="adresse" rows="2" required="required" class="form-control" placeholder="Adresse complet"></textarea>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="contact" class="col-form-label col-sm-3 required">Contact</label>
                            <div class="col-sm-9">
                                <input type="text" id="contact" name="contact" required="required" class="form-control" palceholder="Nom du budget"/>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-form-label col-sm-3 required">Type</label>
                            <div class="col-sm-9">
                                <select name="type" class="form-control">
                                    <option value="F">Fournisseur</option>
                                    <option value="C">Client</option>
                                    <option value="S">Salarié</option>
                                    <option value="A">Autre</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-form-label col-sm-3 required">Compte collectif</label>
                            <div class="col-sm-9">
                                <select name="poste" class="form-control" required>
                                    {% for compte in comptesTiers %}
                                        <option value="{{ compte.poste }}">{{ compte.poste ~' '~ compte.titre}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-group text-right">
                            <button type="button" class="btn btn-danger" data-dismiss="modal">Fermer</button>
                            <button type="submit" class="btn btn-info">OK</button>
                        </div>
                    </form>
                </div>
                
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
<script>
    var tiers = {{tiers|raw}};
    console.log(tiers);

    const refreshTable = function() {
        $('#tiers tbody').empty();
        $('#tiers tfoot').empty();
        
        for (let index = 0; index < tiers.length; index++) {
            var tier = tiers[index];
            var markup = "<tr><th scope='row'><span class='label label-rounded label-primary'>"+ tier.type +"</span></th>";
            markup += "<td>" + tier.code + "</td>";
            markup += "<td>" + tier.libelle + "</td>";
            markup += "<td>" + tier.adresse + "</td>";
            markup += "<td>" + tier.contact + "</td>";
            markup += "<td>" + tier.poste + "</td>";         
            if (true) {
                markup += "<td><a class='btn' href='/comptabilite/tier/"+ tier.id +"'><i class='fa fa-eye' aria-hidden='true'></i></a></td>";
            } else {
                markup += "<td><a href='#' class='btn disabled'><i class='fa fa-eye' aria-hidden='true'></i></a></td>";
            }
            markup += "</tr>";
            $('#tiers tbody').append(markup);                   
        }
    }
    refreshTable();

    $("#form").submit(function(event){
        event.preventDefault(); 
            var post_url = window.location.href;
            var form_data = $(this).serialize();
            
            $.post( post_url, form_data, function(response) {
                if (response.hasError == false) {
                    console.log('success');
                    tiers.push(response.tier);
                    refreshTable();
                    $('#form-dialog').modal('hide');
                } else {
                    console.log('error');
                }                   
            });
        
    });
</script>
{% endblock %}